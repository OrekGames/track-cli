# GitLab CI/CD Pipeline for Track CLI
# Builds cross-platform binaries and publishes to GitLab Package Registry

stages:
  - test
  - build
  - package
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUSTFLAGS: "-D warnings"
  PACKAGE_NAME: "track"
  SECRET_DETECTION_ENABLED: 'true'

# Cache cargo dependencies between jobs
.cargo-cache: &cargo-cache
  cache:
    key:
      files:
        - Cargo.lock
    paths:
      - .cargo/registry/
      - .cargo/git/
      - target/

# ------------------------------------------------------------------------------
# Test Stage
# ------------------------------------------------------------------------------

test:unit:
  stage: test
  image: rust:1.93
  <<: *cargo-cache
  script:
    - rustc --version && cargo --version
    # Exclude bin-only crates from --lib/--doc to avoid "no library targets" errors.
    - cargo test --workspace --all-features --exclude track --exclude agent-harness --lib
    - cargo test --workspace --all-features --exclude track --exclude agent-harness --doc
    - cargo test -p track --all-features --bins
    - cargo test -p agent-harness --all-features --bins
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

clippy:
  stage: test
  image: rust:1.93
  <<: *cargo-cache
  script:
    - rustup component add clippy
    - cargo clippy --workspace --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

fmt:
  stage: test
  image: rust:1.93
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

secret_detection:
  stage: test

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

# ------------------------------------------------------------------------------
# Build Stage - Cross-compilation using cargo-zigbuild
# ------------------------------------------------------------------------------

.build-template: &build-template
  stage: build
  image: rust:1.93
  <<: *cargo-cache
  before_script:
    - apt-get update && apt-get install -y wget xz-utils mingw-w64 llvm
    # Install Zig (required for cargo-zigbuild)
    - wget -q https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz
    - tar -xf zig-linux-x86_64-0.13.0.tar.xz
    - export PATH="$PWD/zig-linux-x86_64-0.13.0:$PATH"
    - zig version
    # Install cargo-zigbuild
    - cargo install cargo-zigbuild
  rules:
    - if: $CI_COMMIT_TAG

# Linux x86_64
build:linux-x86_64:
  <<: *build-template
  script:
    - rustup target add x86_64-unknown-linux-gnu
    - cargo zigbuild --release --target x86_64-unknown-linux-gnu --package track
    - mkdir -p artifacts/linux-x86_64
    - cp target/x86_64-unknown-linux-gnu/release/track artifacts/linux-x86_64/
    # Generate shell completions
    - ./artifacts/linux-x86_64/track completions bash > artifacts/linux-x86_64/track.bash
    - ./artifacts/linux-x86_64/track completions zsh > artifacts/linux-x86_64/_track
    - ./artifacts/linux-x86_64/track completions fish > artifacts/linux-x86_64/track.fish
  artifacts:
    paths:
      - artifacts/linux-x86_64/
    expire_in: 1 week

# Linux aarch64
build:linux-aarch64:
  <<: *build-template
  script:
    - rustup target add aarch64-unknown-linux-gnu
    - cargo zigbuild --release --target aarch64-unknown-linux-gnu --package track
    - mkdir -p artifacts/linux-aarch64
    - cp target/aarch64-unknown-linux-gnu/release/track artifacts/linux-aarch64/
  artifacts:
    paths:
      - artifacts/linux-aarch64/
    expire_in: 1 week

# macOS x86_64 (Intel)
build:macos-x86_64:
  <<: *build-template
  script:
    - rustup target add x86_64-apple-darwin
    - cargo zigbuild --release --target x86_64-apple-darwin --package track
    - mkdir -p artifacts/macos-x86_64
    - cp target/x86_64-apple-darwin/release/track artifacts/macos-x86_64/
  artifacts:
    paths:
      - artifacts/macos-x86_64/
    expire_in: 1 week

# macOS aarch64 (Apple Silicon)
build:macos-aarch64:
  <<: *build-template
  script:
    - rustup target add aarch64-apple-darwin
    - cargo zigbuild --release --target aarch64-apple-darwin --package track
    - mkdir -p artifacts/macos-aarch64
    - cp target/aarch64-apple-darwin/release/track artifacts/macos-aarch64/
    # Generate shell completions (use linux binary since we can't run macOS binary)
  artifacts:
    paths:
      - artifacts/macos-aarch64/
    expire_in: 1 week

# Windows x86_64 (GNU)
build:windows-x86_64:
  <<: *build-template
  variables:
    DLLTOOL: "llvm-dlltool"
  script:
    - rustup target add x86_64-pc-windows-gnu
    - cargo zigbuild --release --target x86_64-pc-windows-gnu --package track
    - mkdir -p artifacts/windows-x86_64
    - cp target/x86_64-pc-windows-gnu/release/track.exe artifacts/windows-x86_64/
  artifacts:
    paths:
      - artifacts/windows-x86_64/
    expire_in: 1 week

# # Windows ARM64 (GNU)
build:windows-aarch64:
  <<: *build-template
  variables:
    DLLTOOL: "llvm-dlltool"
  script:
    - rustup target add aarch64-pc-windows-gnu
    - cargo zigbuild --release --target aarch64-pc-windows-gnu --package track
      - mkdir -p artifacts/windows-aarch64
      - cp target/aarch64-pc-windows-gnu/release/track.exe artifacts/windows-aarch64/
  artifacts:
    paths:
      - artifacts/windows-aarch64/
    expire_in: 1 week

# ------------------------------------------------------------------------------
# Package Stage - Create release tarballs
# ------------------------------------------------------------------------------

package:
  stage: package
  image: alpine:latest
  needs:
    - build:linux-x86_64
    - build:linux-aarch64
    - build:macos-x86_64
    - build:macos-aarch64
    - build:windows-x86_64
    - build:windows-aarch64
  before_script:
    - apk add --no-cache tar gzip coreutils zip
  script:
    - VERSION=${CI_COMMIT_TAG#v}  # Remove 'v' prefix if present
    - mkdir -p dist

    # Package Linux x86_64
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu
    - cp artifacts/linux-x86_64/track ${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu/
    - cp artifacts/linux-x86_64/*.bash artifacts/linux-x86_64/_track artifacts/linux-x86_64/*.fish ${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu/ 2>/dev/null || true
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu/ 2>/dev/null || true
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu.tar.gz ${PACKAGE_NAME}-${VERSION}-x86_64-unknown-linux-gnu

    # Package Linux aarch64
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu
    - cp artifacts/linux-aarch64/track ${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu/
    - cp artifacts/linux-x86_64/*.bash artifacts/linux-x86_64/_track artifacts/linux-x86_64/*.fish ${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu/ 2>/dev/null || true
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu/ 2>/dev/null || true
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu.tar.gz ${PACKAGE_NAME}-${VERSION}-aarch64-unknown-linux-gnu

    # Package macOS x86_64
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin
    - cp artifacts/macos-x86_64/track ${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin/
    - cp artifacts/linux-x86_64/*.bash artifacts/linux-x86_64/_track artifacts/linux-x86_64/*.fish ${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin/ 2>/dev/null || true
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin/ 2>/dev/null || true
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin.tar.gz ${PACKAGE_NAME}-${VERSION}-x86_64-apple-darwin

    # Package macOS aarch64
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin
    - cp artifacts/macos-aarch64/track ${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin/
    - cp artifacts/linux-x86_64/*.bash artifacts/linux-x86_64/_track artifacts/linux-x86_64/*.fish ${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin/ 2>/dev/null || true
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin/ 2>/dev/null || true
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin.tar.gz ${PACKAGE_NAME}-${VERSION}-aarch64-apple-darwin

    # Package Windows x86_64 (GNU)
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-x86_64-pc-windows-gnu
    - cp artifacts/windows-x86_64/track.exe ${PACKAGE_NAME}-${VERSION}-x86_64-pc-windows-gnu/
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-x86_64-pc-windows-gnu/ 2>/dev/null || true
    - zip -r dist/${PACKAGE_NAME}-${VERSION}-x86_64-pc-windows-gnu.zip ${PACKAGE_NAME}-${VERSION}-x86_64-pc-windows-gnu

    # Package Windows ARM64 (GNU)
    - mkdir -p ${PACKAGE_NAME}-${VERSION}-aarch64-pc-windows-gnu
    - cp artifacts/windows-aarch64/track.exe ${PACKAGE_NAME}-${VERSION}-aarch64-pc-windows-gnu/
    - cp README.md LICENSE ${PACKAGE_NAME}-${VERSION}-aarch64-pc-windows-gnu/ 2>/dev/null || true
    - zip -r dist/${PACKAGE_NAME}-${VERSION}-aarch64-pc-windows-gnu.zip ${PACKAGE_NAME}-${VERSION}-aarch64-pc-windows-gnu

    # Generate checksums
    - cd dist && sha256sum *.tar.gz *.zip > checksums-sha256.txt && cd ..
    - cat dist/checksums-sha256.txt
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG

# ------------------------------------------------------------------------------
# Release Stage - Publish to Package Registry and create Release
# ------------------------------------------------------------------------------

publish:package-registry:
  stage: release
  image: curlimages/curl:latest
  needs:
    - package
  script:
    - VERSION=${CI_COMMIT_TAG#v}
    - |
      for file in dist/*.tar.gz dist/checksums-sha256.txt; do
        filename=$(basename "$file")
        echo "Uploading $filename..."
        curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
             --upload-file "$file" \
             "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${filename}"
      done
  rules:
    - if: $CI_COMMIT_TAG

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - package
    - publish:package-registry
  script:
    - VERSION=${CI_COMMIT_TAG#v}
    - echo "Creating release for version ${VERSION}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## Installation

      ### Homebrew (macOS)
      ```bash
      brew tap your-group/track
      brew install track
      ```

      ### Manual Download
      Download the appropriate archive for your platform from the assets below.

      ### Cargo
      ```bash
      cargo install --git https://gitlab.com/your-group/youtrack-cli.git track
      ```

      ## Checksums
      See `checksums-sha256.txt` for SHA256 checksums of all archives.
    assets:
      links:
        - name: "Linux x86_64"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-x86_64-unknown-linux-gnu.tar.gz"
          link_type: package
        - name: "Linux aarch64"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-aarch64-unknown-linux-gnu.tar.gz"
          link_type: package
        - name: "macOS Intel (x86_64)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-x86_64-apple-darwin.tar.gz"
          link_type: package
        - name: "macOS Apple Silicon (aarch64)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-aarch64-apple-darwin.tar.gz"
          link_type: package
        - name: "Windows x86_64 (GNU)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-x86_64-pc-windows-gnu.zip"
          link_type: package
        - name: "Windows ARM64 (GNU)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/${PACKAGE_NAME}-${CI_COMMIT_TAG#v}-aarch64-pc-windows-gnu.zip"
          link_type: package
        - name: "Checksums (SHA256)"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_TAG#v}/checksums-sha256.txt"
          link_type: other
  rules:
    - if: $CI_COMMIT_TAG
